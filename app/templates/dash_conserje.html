{% extends "base.html" %}
{% block title %}| Conserjería{% endblock %}

{% block styles %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    ∏

    /* Estilos Conserjería */
    .card-glass {
        background: rgba(20, 20, 30, 0.85);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        color: white;
    }

    /* Parking Grid */
    .parking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
    }

    .park-slot {
        height: 140px;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        transition: 0.2s;
        overflow: hidden;
    }

    .park-slot:hover {
        transform: scale(1.05);
        z-index: 10;
        border-color: white;
    }

    .slot-name {
        font-size: 1.5rem;
        font-weight: 800;
        text-transform: uppercase;
        width: 100%;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .slot-icon {
        font-size: 2.5rem;
        line-height: 1;
    }

    .slot-timer {
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: bold;
        color: #ffc107;
        width: 100%;
        text-align: center;
    }

    /* Estados Parking */
    .park-libre {
        border-color: #2ecc71;
        color: #2ecc71;
    }

    .park-libre .slot-icon {
        color: #2ecc71;
    }

    .park-ocupado {
        background: rgba(241, 196, 15, 0.15);
        border-color: #f1c40f;
        color: white;
    }

    .park-ocupado .slot-icon {
        color: #f1c40f;
    }

    .park-mantencion {
        background: rgba(52, 152, 219, 0.15);
        border-color: #3498db;
        opacity: 0.7;
        color: #3498db;
    }

    /* Botones Grandes */
    .btn-action-lg {
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 16px;
        font-size: 1.1rem;
        font-weight: bold;
        text-transform: uppercase;
        border: none;
        transition: 0.3s;
        color: white;
    }

    .btn-action-lg i {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .bg-qr {
        background: linear-gradient(135deg, #45A29E, #2a615e); /* Muted Teal */
    }

    .bg-box {
        background: linear-gradient(135deg, #6c757d, #495057); /* Gray */
    }

    .bg-log {
        background: linear-gradient(135deg, #66FCF1, #45A29E); /* Primary Accent */
    }

    .bg-sos {
        background: linear-gradient(135deg, #e74c3c, #c0392b); /* Red */
    }

    .bg-shift {
        background: linear-gradient(135deg, #45A29E, #1F2833); /* Muted Teal to Dark */
    }

    .bg-meter {
        background: linear-gradient(135deg, #6c757d, #343a40); /* Gray */
    }

    .bg-access {
        background: linear-gradient(135deg, #343a40, #212529);
        border: 1px dashed rgba(255, 255, 255, 0.3) !important;
    }

    .table {
        color: white;
    }

    .table tbody td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        vertical-align: middle;
    }

    .form-control,
    .form-select {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    #reader {
        width: 100%;
        border-radius: 12px;
        border: 2px solid #0dcaf0;
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-glass fixed-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center gap-2 text-white" href="#" style="--bs-info-rgb: 102, 252, 241;">
            <i class="bi bi-shield-lock-fill text-info fs-3" style="color: var(--accent-primary) !important;"></i>
            <span class="fw-bold fs-4">Conserjería <span class="fw-light opacity-50">{{ edificio.nombre }}</span></span>
        </a>
        <div class="d-flex align-items-center gap-3">
            <span class="text-white me-2">{{ session.nombre }}</span>
            <a href="/logout" class="btn btn-outline-danger border-0"><i class="bi bi-power fs-4"></i></a>
        </div>
    </div>
</nav>

<div class="container-fluid px-4" style="margin-top: 100px; padding-bottom: 50px;">
    {% with msgs = get_flashed_messages() %}
    {% if msgs %}
    <div
        style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 80%; max-width: 900px;">
        {% for m in msgs %}
        <div class="alert alert-success bg-success bg-opacity-75 text-white border-0 text-center shadow-lg rounded-pill"
            role="alert">{{ m }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- BOTONES DE ACCIÓN RÁPIDA (REORGANIZADOS ESTILO COMUNIDAD FELIZ) -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-qr w-100" data-bs-toggle="modal"
                data-bs-target="#modalQR"><i class="bi bi-qr-code-scan"></i> Escanear Pase</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-box w-100" data-bs-toggle="modal"
                data-bs-target="#modalEncomienda"><i class="bi bi-box-seam"></i> Recepción</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-log w-100" data-bs-toggle="modal"
                data-bs-target="#modalBitacora"><i class="bi bi-journal-text"></i> Bitácora</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-meter w-100" data-bs-toggle="modal"
                data-bs-target="#modalMedidores"><i class="bi bi-speedometer"></i> Medidores</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-shift w-100" data-bs-toggle="modal"
                data-bs-target="#modalTurno"><i class="bi bi-arrow-left-right"></i> Entrega Turno</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-sos w-100" onclick="enviarAlerta()"><i
                    class="bi bi-megaphone"></i> Alerta SOS</button></div>
    </div>

    <!-- SECCIÓN DE ACCESOS REMOTOS (SIMULADOS) -->
    <h6 class="text-white-50 text-uppercase small fw-bold mb-3 ps-1"><i class="bi bi-cpu me-1"></i> Accesos Remotos
        (IoT)</h6>
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-access w-100"
                onclick="abrirAcceso('Puerta Principal')">
                <i class="bi bi-door-open-fill"></i> Abrir Principal</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-access w-100"
                onclick="abrirAcceso('Portón Vehicular')">
                <i class="bi bi-p-circle-fill"></i> Abrir Portón</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-access w-100"
                onclick="abrirAcceso('Bóveda de Seguridad')">
                <i class="bi bi-safe2-fill"></i> Abrir Bóveda</button></div>
        <div class="col-6 col-md-3"><button class="btn-action-lg bg-access w-100" onclick="abrirAcceso('Gimnasio')">
                <i class="bi bi-bicycle"></i> Abrir Gimnasio</button></div>
    </div>

    <div class="card-glass p-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0 fw-bold" style="--bs-primary-rgb: 102, 252, 241;"><i class="bi bi-p-square-fill me-2 text-primary"></i> Control de Estacionamiento
            </h4>
        </div>

        <!-- LEYENDA SEPARADA (MEJORA SOLICITADA) -->
        <div
            class="d-flex gap-4 mb-4 p-2 rounded bg-black bg-opacity-25 border border-secondary justify-content-center text-white-50 small">
            <span class="d-flex align-items-center"><i class="bi bi-circle-fill text-success me-2"></i> Libre</span>
            <span class="d-flex align-items-center"><i class="bi bi-circle-fill text-warning me-2"></i> Ocupado</span>
            <span class="d-flex align-items-center"><i class="bi bi-circle-fill me-2" style="color: #66FCF1;"></i> Mantención</span>
        </div>

        <div class="parking-grid">
            {% for p in parking %}
            <div class="park-slot park-{{ p.estado }}"
                onclick="gestionarParking('{{ p.id }}', '{{ p.nombre }}', '{{ p.estado }}', '{{ p.patente }}')">

                <div class="slot-name">{{ p.nombre }}</div>

                <div class="slot-icon">
                    {% if p.estado == 'libre' %}<i class="bi bi-check-circle"></i>
                    {% elif p.estado == 'mantencion' %}<i class="bi bi-cone-striped"></i>
                    {% elif p.estado == 'asignado' %}<i class="bi bi-house-lock"></i>{% endif %}
                </div>

                {% if p.estado == 'ocupado' %}
                <div class="lh-1 text-center w-100">
                    <div class="badge bg-white text-danger mb-1" style="font-size: 0.7rem;">
                        Depto {{ p.unidad_numero }}
                    </div>

                    <div class="fw-bold text-warning small mb-1">{{ p.patente }}</div>
                    <div class="slot-timer" id="timer-{{ p.id }}" data-elapsed="{{ p.tiempo }}">Calculando...</div>
                </div>

                {% elif p.estado == 'libre' %}
                <small class="fw-bold">LIBRE</small>

                {% elif p.estado == 'mantencion' %}
                <small class="fw-bold" style="font-size:0.6rem">MANTENCIÓN</small>

                {% else %}
                <small class="text-info fw-bold">U. {{ p.unidad_numero }}</small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card-glass p-3 h-100">
                <h5 class="fw-bold mb-3"><i class="bi bi-calendar-check text-success me-2"></i> Agenda & Control de
                    Llaves</h5>
                <div class="d-flex gap-3 overflow-auto pb-2 mb-3">
                    {% for r in reservas_futuras %}
                    <div id="reserva-card-{{ loop.index }}"
                        class="bg-dark border border-secondary p-2 rounded text-center" style="min-width: 160px;">
                        <div class="text-white fw-bold">{{ r.nombre_espacio }}</div>
                        <div class="fw-bold small my-1" style="color: #66FCF1;">
                            {{ r.fecha_uso.strftime('%d/%m') }}
                            <br>
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-clock"></i> {{ r.hora_inicio or '--:--' }}
                            </span>
                        </div>
                        <div class="small text-white-50 mb-2">U. {{ r.numero_unidad }}</div>
                        <button id="reserva-btn-{{ loop.index }}" class="btn btn-xxs py-0" style="font-size: 0.6rem; --bs-btn-border-color: #66FCF1; --bs-btn-hover-bg: #66FCF1; --bs-btn-hover-border-color: #66FCF1; --bs-btn-hover-color: #0B0C10; --bs-btn-color: #66FCF1;"
                            style="font-size: 0.6rem;"
                            onclick="gestionarLlave('{{ r.nombre_espacio }}', '{{ r.numero_unidad }}', {{ loop.index }})">
                            <i class="bi bi-key"></i> ENTREGAR LLAVE
                        </button>
                    </div>
                    {% else %}
                    <div class="text-white-50 small">No hay reservas próximas.</div>
                    {% endfor %}
                </div>

                <div class="bg-black bg-opacity-25 rounded p-3 border border-secondary">
                    <h6 class="small fw-bold mb-2" style="color: #66FCF1;"><i class="bi bi-key-fill me-1"></i> Llaves en Uso</h6>
                    <div id="llavesEnUso">
                        <div class="text-white-50 small italic">No hay llaves registradas como "fuera de conserjería".
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-glass p-3 h-100">
                <h5 class="fw-bold mb-3" style="--bs-info-rgb: 102, 252, 241;"><i class="bi bi-info-circle text-info me-2"></i> Estado del Turno</h5>
                <div class="list-group list-group-flush bg-transparent">
                    <div class="list-group-item bg-transparent border-secondary px-0">
                        <div class="d-flex justify-content-between small">
                            <span class="text-white-50">Conserje Actual:</span>
                            <span class="text-white fw-bold">{{ session.nombre }}</span>
                        </div>
                    </div>
                    <div class="list-group-item bg-transparent border-secondary px-0">
                        <div class="d-flex justify-content-between small">
                            <span class="text-white-50">Inicio Turno:</span>
                            <span class="fw-bold" style="color: #66FCF1;">08:00 AM</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-warning w-100 mt-3 fw-bold" data-bs-toggle="modal"
                    data-bs-target="#modalTurno">FINALIZAR MI TURNO</button>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-glass p-3 h-100">
                <h5 class="fw-bold mb-3"><i class="bi bi-box2-fill text-warning me-2"></i> Por Entregar</h5>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr class="text-white-50 small">
                                <th>U.</th>
                                <th>Remitente</th>
                                <th>Hora</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in encomiendas %}
                            <tr>
                                <td><span class="badge bg-warning text-dark">{{ e.unidad }}</span></td>
                                <td class="fw-bold">{{ e.remitente }}</td>
                                <td class="small text-white-50">{{ e.recepcion.strftime('%H:%M') }}</td>
                                <td>
                                    <form action="/conserje/encomiendas/entregar" method="POST">
                                        <input type="hidden" name="encomienda_id" value="{{ e.id }}">
                                        <button class="btn btn-sm btn-outline-success"><i
                                                class="bi bi-check-lg"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-white-50 py-4">No hay paquetes.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card-glass p-3 h-100">
                <h5 class="fw-bold mb-3" style="--bs-info-rgb: 102, 252, 241;"><i class="bi bi-people-fill text-info me-2"></i> Directorio Residentes</h5>
                <input type="text" id="buscadorResidentes" class="form-control mb-3"
                    placeholder="Buscar unidad o nombre...">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover align-middle" id="tablaResidentes">
                        <thead>
                            <tr class="text-white-50 small">
                                <th>Depto</th>
                                <th>Residente</th>
                                <th>RUT (Usuario)</th>
                                <th>Rol</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in unidades %}
                            <tr>
                                <td><span class="fs-6 fw-bold" style="color: #66FCF1;">{{ u.numero }}</span></td>
                                <td>
                                    <div class="small fw-bold">{{ u.residente }}</div>
                                    <div class="small text-white-50" style="font-size: 0.75rem;">{{ u.email }}</div>
                                </td>
                                <td class="font-monospace small">
                                    {{ u.tenant.rut if u.tenant.rut else u.owner.rut }}
                                </td>
                                <td>
                                    {% if u.tenant.nombre %}
                                    <span class="badge bg-info text-dark"
                                        style="font-size: 0.65rem;">ARRENDATARIO</span>
                                    {% else %}
                                    <span class="badge bg-primary bg-opacity-50"
                                        style="font-size: 0.65rem;">PROPIETARIO</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end gap-1">
                                        {% if u.fono %}
                                        <a href="https://wa.me/{{ u.fono | replace('+','') | replace(' ','') }}"
                                            target="_blank" class="btn btn-sm btn-success" title="WhatsApp">
                                            <i class="bi bi-whatsapp"></i>
                                        </a>
                                        {% endif %}

                                        <button class="btn btn-sm btn-outline-warning"
                                            onclick='abrirEditarCompleto({{ u | tojson }})' title="Editar Ficha">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>

                                        <button class="btn btn-sm btn-outline-danger"
                                            onclick="abrirMulta({{ u.id }}, '{{ u.numero }}')" title="Multar">
                                            <i class="bi bi-receipt"></i>
                                        </button>

                                        <button class="btn btn-sm" style="--bs-btn-border-color: #66FCF1; --bs-btn-hover-bg: #66FCF1; --bs-btn-hover-border-color: #66FCF1; --bs-btn-hover-color: #0B0C10; --bs-btn-color: #66FCF1;"
                                            onclick="resetClave({{ u.id }}, '{{ u.tenant.rut if u.tenant.rut else u.owner.rut }}')"
                                            title="Reset Clave">
                                            <i class="bi bi-key-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCompleto" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Editar Ficha Residente</h5><button type="button"
                    class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/admin/residentes/guardar_edicion" method="POST">
                    <input type="hidden" name="unidad_id" id="editFullId">
                    <div class="row g-2 mb-3">
                        <div class="col"><label class="small text-white-50">Piso</label><input type="number" name="piso"
                                id="editFullPiso" class="form-control"></div>
                        <div class="col"><label class="small text-white-50">Prorrateo %</label><input type="text"
                                name="prorrateo" id="editFullProrrateo" class="form-control"></div>
                    </div>
                    <hr class="border-secondary">
                    <h6 class="small mb-3" style="color: #66FCF1;">Datos de Contacto</h6>
                    <div class="mb-2"><label class="small text-muted">Nombre</label><input type="text"
                            name="tenant_nombre" id="editFullNombre" class="form-control"></div>
                    <div class="mb-2"><label class="small text-muted">RUT</label><input type="text" name="tenant_rut"
                            id="editFullRut" class="form-control"></div>
                    <div class="mb-2"><label class="small text-muted">Email</label><input type="email"
                            name="tenant_email" id="editFullEmail" class="form-control"></div>
                    <div class="mb-3"><label class="small text-muted">Teléfono / WhatsApp</label><input type="text"
                            name="tenant_fono" id="editFullFono" class="form-control"></div>
                    <button class="btn btn-warning w-100 fw-bold">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMultar" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header border-0 bg-danger bg-opacity-25">
                <h6 class="modal-title">Aplicar Multa U.<span id="multaUnitNum"></span></h6><button type="button"
                    class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/admin/residentes/multar" method="POST"><input type="hidden" name="unidad_id"
                        id="multaUnitId">
                    <div class="mb-2"><label class="small">Motivo</label><input type="text" name="motivo"
                            class="form-control" placeholder="Ej: Ruidos" required></div>
                    <div class="mb-3"><label class="small">Monto ($)</label><input type="number" name="monto_multa"
                            class="form-control" required></div><button
                        class="btn btn-danger w-100 btn-sm fw-bold">Multar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalQR" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header border-0">
                <h5 class="modal-title">Escanear Pase</h5><button type="button" class="btn-close btn-close-white"
                    data-bs-dismiss="modal" onclick="stopScanner()"></button>
            </div>
            <div class="modal-body text-center">
                <div id="reader"></div>
                <div id="scanResult" class="mt-3 fw-bold text-warning"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEncomienda" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Paquete</h5><button type="button" class="btn-close btn-close-white"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/conserje/encomiendas/guardar" method="POST">
                    <div class="mb-3"><label>Unidad Destino</label><select name="unidad_id"
                            class="form-select bg-dark text-white border-secondary">{% for u in unidades %}<option
                                value="{{ u.id }}">{{ u.numero }} - {{ u.residente }}</option>{% endfor %}</select>
                    </div>
                    <div class="mb-3"><label>Remitente</label><input type="text" name="remitente"
                            class="form-control bg-dark text-white" required></div><button
                        class="btn btn-warning w-100 fw-bold">Registrar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MEDIDORES (NUEVO) -->
<div class="modal fade" id="modalMedidores" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-speedometer me-2"></i>Lectura de Medidores</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="lastReadingInfo"
                    class="alert alert-info bg-opacity-10 border-info text-info small mb-3 d-none">
                    <i class="bi bi-info-circle me-1"></i>
                    Última lectura: <strong id="lastReadingValue">--</strong>
                    (<span id="lastReadingDate">--</span>)
                </div>

                <form action="/conserje/medidores/guardar" method="POST">
                    <div class="mb-3">
                        <label class="small text-white-50">Unidad</label>
                        <select name="unidad_id" id="meterUnitSelect"
                            class="form-select bg-dark text-white border-secondary" onchange="fetchUltimaLectura()">
                            {% for u in unidades %}<option value="{{ u.id }}">{{ u.numero }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="small text-white-50">Tipo</label>
                            <select name="tipo" id="meterTypeSelect"
                                class="form-select bg-dark text-white border-secondary" onchange="fetchUltimaLectura()">
                                <option>Agua Caliente</option>
                                <option>Agua Fría</option>
                                <option>Gas</option>
                                <option>Electricidad</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="small text-white-50">Lectura Actual</label>
                            <input type="number" step="0.01" name="valor" class="form-control bg-dark text-white"
                                required>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 fw-bold">REGISTRAR LECTURA</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ENTREGA DE TURNO (NUEVO) -->
<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-arrow-left-right me-2"></i>Entrega de Turno</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/conserje/turno/guardar" method="POST">
                    <div class="mb-3"><label class="small text-white-50">Novedades Relevantes</label><textarea
                            name="novedades" class="form-control bg-dark text-white" rows="3"
                            placeholder="Ej: Se deja encargo de depto 204, portón con ruido..."></textarea></div>
                    <div class="mb-3"><label class="small text-white-50">Efectivo en Caja ($)</label><input
                            type="number" name="caja" class="form-control bg-dark text-white" value="0"></div>
                    <div class="alert alert-info small py-2"><i class="bi bi-info-circle me-1"></i> Al confirmar, se
                        generará un registro en la bitácora del administrador.</div>
                    <button class="btn btn-info w-100 fw-bold text-dark">CONFIRMAR ENTREGA DE TURNO</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBitacora" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1a1d24; color:white;">
            <div class="modal-header">
                <h5 class="modal-title">Bitácora</h5><button type="button" class="btn-close btn-close-white"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="/conserje/incidencias/guardar" method="POST">
                    <div class="mb-3"><label>Título</label><input type="text" name="titulo"
                            class="form-control bg-dark text-white" required></div>
                    <div class="mb-3"><label>Descripción</label><textarea name="descripcion"
                            class="form-control bg-dark text-white" rows="3" required></textarea></div><button
                        class="btn btn-info w-100 fw-bold text-dark">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // TIMER
    const LLAVES_STORAGE_KEY = `habipro_llaves_{{ edificio.id }}`;

    document.addEventListener("DOMContentLoaded", function () {
        const slots = document.querySelectorAll('.slot-timer');
        slots.forEach(slot => {
            const elapsedStr = slot.getAttribute('data-elapsed');
            if (!elapsedStr) return;
            let elapsedMinutes = 0;
            const parts = elapsedStr.split(' ');
            parts.forEach(p => {
                if (p.includes('h')) elapsedMinutes += parseInt(p) * 60;
                if (p.includes('m')) elapsedMinutes += parseInt(p);
            });
            const limitMinutes = 300;
            const remaining = limitMinutes - elapsedMinutes;
            if (remaining > 0) {
                const h = Math.floor(remaining / 60); const m = remaining % 60;
                slot.innerHTML = `<i class="bi bi-hourglass-split"></i> ${h}h ${m}m`;
                if (remaining < 60) slot.style.color = '#ff4757';
            } else { slot.innerHTML = "¡TIEMPO AGOTADO!"; slot.style.backgroundColor = "#dc3545"; slot.style.color = "white"; }
        });

        renderizarLlavesEnUso();
    });

    // ABRE EL MODAL DE EDICIÓN COMPLETA
    function abrirEditarCompleto(u) {
        document.getElementById('editFullId').value = u.id;
        document.getElementById('editFullPiso').value = u.piso || '';
        document.getElementById('editFullProrrateo').value = u.prorrateo || '';
        document.getElementById('editFullNombre').value = u.residente;
        document.getElementById('editFullRut').value = u.rut;
        document.getElementById('editFullEmail').value = u.email;
        document.getElementById('editFullFono').value = u.fono;
        new bootstrap.Modal(document.getElementById('modalEditarCompleto')).show();
    }

    function abrirMulta(uid, numero) {
        document.getElementById('multaUnitId').value = uid;
        document.getElementById('multaUnitNum').innerText = numero;
        new bootstrap.Modal(document.getElementById('modalMultar')).show();
    }

    function resetClave(uid, rutUsuario) {
        if (!confirm('¿Generar nueva contraseña?')) return;
        fetch('/admin/residentes/reset_clave', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `unidad_id=${uid}`
        })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    Swal.fire({
                        title: '¡Acceso Generado!',
                        html: `
                        <div class="text-start bg-dark p-3 rounded border border-secondary">
                            <p class="mb-2 text-white-50">Datos de acceso:</p>
                            <div class="mb-2">Usuario (RUT): <strong class="text-info fs-5">${rutUsuario}</strong></div>
                            <div>Contraseña: <strong class="text-warning fs-4">${d.password}</strong></div>
                        </div>
                        <button class="btn btn-sm btn-outline-light mt-2" onclick="navigator.clipboard.writeText('${d.password}')">Copiar</button>
                    `,
                        icon: 'success', background: '#1a1d24', color: '#fff'
                    });
                } else { Swal.fire({ title: 'Error', text: d.message, icon: 'error', background: '#1a1d24', color: '#fff' }); }
            });
    }

    function abrirAcceso(nombre) {
        Swal.fire({
            title: nombre,
            text: 'Servicio no contratado',
            icon: 'warning',
            background: '#1a1d24',
            color: '#fff',
            confirmButtonColor: '#0dcaf0'
        });
    }

    // QR & OTROS
    let html5QrcodeScanner;
    document.getElementById('modalQR').addEventListener('shown.bs.modal', function () { html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }); html5QrcodeScanner.render(onScanSuccess); });
    document.getElementById('modalQR').addEventListener('hidden.bs.modal', stopScanner);
    function stopScanner() { if (html5QrcodeScanner) html5QrcodeScanner.clear().catch(e => console.error(e)); }
    function onScanSuccess(decodedText) {
        html5QrcodeScanner.clear();

        Swal.fire({
            title: 'Validando...',
            didOpen: () => { Swal.showLoading() },
            background: '#1a1d24', color: '#fff'
        });

        fetch('/conserje/visitas/validar_qr', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `codigo_qr=${decodedText}`
        })
            .then(r => r.json()).then(d => {
                bootstrap.Modal.getInstance(document.getElementById('modalQR')).hide();

                // CASO A: REQUIERE SELECCIÓN DE PARKING (VEHÍCULO)
                if (d.status === 'parking_selection') {

                    // Generamos las opciones del Select
                    let opcionesHTML = '';
                    if (d.slots.length > 0) {
                        d.slots.forEach(s => {
                            opcionesHTML += `<option value="${s.id}">${s.nombre}</option>`;
                        });
                    } else {
                        opcionesHTML = '<option value="">⚠️ NO HAY CUPOS</option>';
                    }

                    Swal.fire({
                        title: 'Asignar Estacionamiento',
                        html: `
                        <div class="text-start bg-dark p-3 rounded mb-3 border border-secondary">
                            <h5 class="text-warning mb-1"><i class="bi bi-car-front-fill"></i> ${d.patente}</h5>
                            <small class="text-white-50">Visita: ${d.visita}</small>
                        </div>
                        <label class="text-white mb-2">Seleccione ubicación:</label>
                        <select id="parkingSelect" class="form-select bg-black text-white border-info text-center fs-5 mb-3">
                            ${opcionesHTML}
                        </select>
                    `,
                        background: '#1a1d24', color: '#fff',
                        showCancelButton: true,
                        confirmButtonText: 'Confirmar Ingreso',
                        confirmButtonColor: '#0dcaf0',
                        preConfirm: () => {
                            const pid = document.getElementById('parkingSelect').value;
                            if (!pid) { Swal.showValidationMessage('Debes seleccionar un estacionamiento o cancelar'); }
                            return pid;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Enviamos la elección al servidor
                            confirmarVehiculo(d.token_invitacion, result.value);
                        }
                    });

                }
                // CASO B: ÉXITO DIRECTO (PEATÓN)
                else if (d.status === 'success') {
                    Swal.fire({
                        title: '¡ACCESO PEATONAL!',
                        html: `<h3 class="text-success">${d.visita}</h3><p>A: Depto ${d.unidad}</p>`,
                        icon: 'success', background: '#1a1d24', color: '#fff', timer: 3000
                    });
                }
                // CASO C: ERROR
                else {
                    Swal.fire({ title: 'Error', text: d.message, icon: 'error', background: '#1a1d24', color: '#fff' });
                }
            });
    }

    // Función auxiliar para enviar la confirmación final
    function confirmarVehiculo(token, parkingId) {
        fetch('/conserje/visitas/confirmar_vehiculo', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `token=${token}&parking_id=${parkingId}`
        })
            .then(r => r.json()).then(final => {
                if (final.status === 'success') {
                    Swal.fire({
                        title: '¡INGRESO REGISTRADO!',
                        html: `
                        <div class="display-1 text-warning"><i class="bi bi-car-front-fill"></i></div>
                        <h2 class="text-white mt-3">PUESTO: ${final.parking_nombre}</h2>
                        <p class="text-white-50">Visita: ${final.visita}</p>
                    `,
                        background: '#1a1d24', color: '#fff', confirmButtonColor: '#28a745'
                    }).then(() => location.reload()); // Recargar para ver el estacionamiento ocupado en el tablero
                }
            });
    }

    function gestionarParking(id, nombre, estado, patente) {
        if (estado === 'mantencion' || estado === 'asignado') return;
        if (estado === 'ocupado') {
            Swal.fire({ title: `Liberar ${nombre}?`, text: `Patente actual: ${patente}`, showCancelButton: true, confirmButtonText: 'Liberar', confirmButtonColor: '#28a745', background: '#1a1d24', color: '#fff' }).then((r) => { if (r.isConfirmed) cambiarEstadoParking(id, 'liberar', ''); });
        } else {
            Swal.fire({ title: `Ocupar ${nombre}`, input: 'text', inputLabel: 'Patente Visita', showCancelButton: true, confirmButtonText: 'Registrar', background: '#1a1d24', color: '#fff' }).then((r) => { if (r.isConfirmed && r.value) cambiarEstadoParking(id, 'ocupar', r.value); });
        }
    }
    function cambiarEstadoParking(id, acc, pat) { fetch('/conserje/parking/toggle', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `slot_id=${id}&accion=${acc}&patente=${pat}` }).then(() => location.reload()); }

    function enviarAlerta() {
        Swal.fire({ title: 'Enviar Alerta SOS', text: 'Se notificará a todos.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', background: '#1a1d24', color: '#fff' }).then((r) => { if (r.isConfirmed) { let f = document.createElement('form'); f.method = 'POST'; f.action = '/admin/difusion'; let i = document.createElement('input'); i.name = 'mensaje'; i.value = 'EMERGENCIA'; f.appendChild(i); document.body.appendChild(f); f.submit(); } });
    }

    function renderizarLlavesEnUso() {
        const llaves = JSON.parse(localStorage.getItem(LLAVES_STORAGE_KEY) || '[]');
        const container = document.getElementById('llavesEnUso');

        if (llaves.length === 0) {
            container.innerHTML = '<div class="text-white-50 small italic">No hay llaves registradas como "fuera de conserjería".</div>';
            return;
        }

        let html = '';
        llaves.forEach(llave => {
            html += `
                <div id="llave-en-uso-${llave.id}" class="d-flex justify-content-between align-items-center bg-dark p-2 rounded mb-1 border border-info">
                    <div>
                        <div class="fw-bold text-white">${llave.espacio}</div>
                        <div class="small text-white-50">Unidad: ${llave.unidad}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-warning py-0" onclick="devolverLlave(${llave.id})">
                        <i class="bi bi-box-arrow-in-left"></i> Devolver
                    </button>
                </div>
            `;
            const btn = document.getElementById(`reserva-btn-${llave.id}`);
            if (btn) {
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-success');
                btn.innerHTML = '<i class="bi bi-check-lg"></i> ENTREGADO';
                btn.disabled = true;
            }
        });
        container.innerHTML = html;
    }

    function devolverLlave(id) {
        let llaves = JSON.parse(localStorage.getItem(LLAVES_STORAGE_KEY) || '[]');
        llaves = llaves.filter(llave => llave.id !== id);
        localStorage.setItem(LLAVES_STORAGE_KEY, JSON.stringify(llaves));

        const btn = document.getElementById(`reserva-btn-${id}`);
        if (btn) {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-info');
            btn.innerHTML = '<i class="bi bi-key"></i> ENTREGAR LLAVE';
            btn.disabled = false;
        }
        renderizarLlavesEnUso();
    }

    function gestionarLlave(espacio, unidad, id) {
        Swal.fire({ title: 'Control de Llaves', text: `¿Confirmas la entrega de la llave de '${espacio}' a la Unidad ${unidad}?`, icon: 'question', showCancelButton: true, confirmButtonText: 'Sí, entregar', background: '#1a1d24', color: '#fff', confirmButtonColor: '#66FCF1' })
            .then(r => {
                if (r.isConfirmed) {
                    const llaves = JSON.parse(localStorage.getItem(LLAVES_STORAGE_KEY) || '[]');
                    if (!llaves.some(llave => llave.id === id)) { llaves.push({ id, espacio, unidad }); localStorage.setItem(LLAVES_STORAGE_KEY, JSON.stringify(llaves)); }
                    Swal.fire({ title: 'Registrado', text: 'Llave marcada como entregada.', icon: 'success', background: '#1a1d24', color: '#fff', timer: 1500, showConfirmButton: false });
                    renderizarLlavesEnUso();
                }
            });
    }

    function fetchUltimaLectura() {
        const uid = document.getElementById('meterUnitSelect').value;
        const tipo = document.getElementById('meterTypeSelect').value;
        const infoBox = document.getElementById('lastReadingInfo');
        const valSpan = document.getElementById('lastReadingValue');
        const dateSpan = document.getElementById('lastReadingDate');

        if (!uid || !tipo) return;

        fetch(`/conserje/medidores/ultima_lectura?unidad_id=${uid}&tipo=${tipo}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    infoBox.classList.remove('d-none');
                    valSpan.innerText = data.valor;
                    dateSpan.innerText = data.fecha;
                }
            });
    }
    document.getElementById('modalMedidores').addEventListener('shown.bs.modal', fetchUltimaLectura);

    document.getElementById('buscadorResidentes').addEventListener('keyup', function () {
        let val = this.value.toLowerCase();
        document.querySelectorAll('#tablaResidentes tbody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
    });
</script>
{% endblock %}