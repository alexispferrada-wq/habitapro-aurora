{% extends "base.html" %}
{% block title %}| Mando Central{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC08hIbpWi529l6GN6Q4BWknbJV4saTJPM&libraries=places"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* CORRECCIÓN GOOGLE AUTOCOMPLETE */
    .pac-container {
        z-index: 10000 !important;
        background-color: #1a1d24;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .pac-item {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        color: #ccc;
        cursor: pointer;
    }

    .pac-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .pac-item-query {
        color: white;
        font-weight: bold;
    }

    /* ESTILOS MODO DIOS */
    .stat-card {
        text-align: center;
        padding: 20px;
        border-bottom: 4px solid var(--accent-blue);
        border-radius: 12px;
    }

    .stat-num {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .log-feed {
        font-size: 0.85rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .log-row {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
    }

    .log-row:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .log-time {
        width: 70px;
        font-size: 0.75rem;
        color: #6c757d;
        text-align: right;
        margin-right: 15px;
    }

    .log-badge {
        width: 90px;
        text-align: center;
        margin-right: 15px;
    }

    .log-content {
        flex-grow: 1;
    }

    .header-dark {
        background-color: rgba(0, 0, 0, 0.6) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        padding: 15px !important;
    }

    .global-status-card {
        background: linear-gradient(135deg, rgba(25, 25, 40, 0.8), rgba(10, 10, 20, 0.8));
        backdrop-filter: blur(15px);
        border: 1px solid rgba(13, 202, 240, 0.2);
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(13, 202, 240, 0.1);
    }

    .metric-box {
        border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .user-count-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.3s;
        position: relative;
        height: 100%;
    }

    .user-count-card:hover {
        border-color: #0dcaf0;
        background: rgba(13, 202, 240, 0.05);
    }

    .user-badge {
        font-size: 1.5rem;
        font-weight: 800;
        color: #0dcaf0;
        text-shadow: 0 0 10px rgba(13, 202, 240, 0.3);
    }

    .btn-delete-float {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

    .btn-delete-float:hover {
        background: #dc3545;
        color: white;
        transform: scale(1.1);
    }

    /* ESTILOS RESULTADOS BÚSQUEDA GHOST */
    .ghost-result-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    /* INDICADORES LED */
    .led-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .led-active {
        background-color: #2ecc71;
        box-shadow: 0 0 10px #2ecc71, 0 0 20px rgba(46, 204, 113, 0.5);
        animation: pulse-green 2s infinite;
    }
    .led-inactive {
        background-color: #e74c3c;
        box-shadow: 0 0 10px #e74c3c;
    }
    @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    @keyframes pulse-blue { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* EFECTO DE PULSO PARA MARCADOR RESALTADO */
    @keyframes marker-pulse-effect {
        0% {
            filter: drop-shadow(0 0 0px #0dcaf0);
        }
        50% {
            filter: drop-shadow(0 0 15px #0dcaf0);
        }
        100% {
            filter: drop-shadow(0 0 0px #0dcaf0);
        }
    }

    .highlight-pulse {
        animation: marker-pulse-effect 1.5s infinite !important;
        z-index: 1000 !important;
    }

    /* ESTILO ICONO EDIFICIO PERSONALIZADO */
    .custom-building-icon {
        background: none;
        border: none;
    }
    .building-marker-inner {
        background: #0dcaf0;
        color: #050505;
        width: 36px;
        height: 36px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(13, 202, 240, 0.4);
        border: 2px solid white;
    }
    .building-marker-inner i {
        transform: rotate(45deg);
        font-size: 1.1rem;
    }

    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #0a0a0f;
    }

    ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-glass fixed-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center gap-2 text-white" href="#">
            <i class="bi bi-cpu-fill text-primary"></i>
            <span class="fw-bold">AEXON <span class="fw-light opacity-75">Overlord</span></span>
        </a>
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-warning fw-bold" data-bs-toggle="modal"
                data-bs-target="#modalGhostLogin">
                <i class="bi bi-incognito me-2"></i> MODO FANTASMA
            </button>
            <a href="/logout" class="btn btn-sm btn-glass">Cerrar Sesión</a>
        </div>
    </div>
</nav>
<div class="bg-black border-bottom border-secondary py-1" style="margin-top: 56px;">
    <div class="container-fluid d-flex justify-content-end gap-4 text-white-50" style="font-size: 0.75rem;">
        <div class="d-flex align-items-center">
            <i class="bi bi-graph-up-arrow text-warning me-1"></i>
            UF: <span class="text-white fw-bold ms-1">${{ "{:,.0f}".format(indicadores.uf) | replace(',', '.') }}</span>
        </div>
        <div class="d-flex align-items-center">
            <i class="bi bi-bank text-success me-1"></i>
            Dólar: <span class="text-white fw-bold ms-1">${{ "{:,.0f}".format(indicadores.dolar) | replace(',', '.') }}</span>
        </div>
        <div class="d-flex align-items-center d-none d-md-flex">
            <i class="bi bi-file-earmark-text text-info me-1"></i>
            UTM: <span class="text-white fw-bold ms-1">${{ "{:,.0f}".format(indicadores.utm) | replace(',', '.') }}</span>
        </div>
    </div>
</div>
<div class="container-fluid px-4" style="margin-top: 90px; padding-bottom: 50px;">

    <div class="row g-4 mb-4">
        <!-- Centro de Control de Infraestructura -->
        <div class="col-xl-8">
            <div class="global-status-card p-4 h-100 border-info border-opacity-50">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h4 class="fw-bold text-info m-0"><i class="bi bi-cpu-fill me-2"></i> Centro de Control AEXON
                        </h4>
                        <p class="text-white-50 small mb-0">Monitoreo de infraestructura y servicios en tiempo real</p>
                    </div>
                    <div class="text-end">
                        <div class="text-white fw-bold fs-3 font-monospace" id="server-time" style="letter-spacing: 2px;">00:00:00</div>
                        <div class="text-white-50 small">Hora Servidor (CL)</div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25 border border-white border-opacity-10">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="bi bi-database-fill text-info"></i>
                                <span class="small fw-bold text-white-50">NEON DATABASE</span>
                            </div>
                            <div class="fw-bold {{ db_info.color }} fs-5">{{ db_info.status }}</div>
                            <div class="text-white-50 mt-1" style="font-size: 0.65rem;">{{ db_info.version }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25 border border-white border-opacity-10">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-cloud-check-fill text-primary"></i>
                                <span class="small fw-bold text-white-50">RENDER HOSTING</span>
                            </div>
                                <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 0.5rem;">LIVE</span>
                            </div>
                            <div class="fw-bold text-success fs-5">OPERATIONAL</div>
                            <div style="height: 40px; position: relative; margin-top: 5px;">
                                <canvas id="renderSparkline"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded bg-black bg-opacity-25 border border-white border-opacity-10">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="bi bi-shield-lock-fill text-warning"></i>
                                <span class="small fw-bold text-white-50">SSL / SECURITY</span>
                            </div>
                            <div class="fw-bold text-white fs-5">ENCRYPTED</div>
                            <div class="text-white-50 mt-1" style="font-size: 0.65rem;">TLS 1.3 Active</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métricas Globales -->
        <div class="col-xl-4">
            <div class="row g-4 h-100">
                <div class="col-12">
                    <div class="card-glass stat-card h-50 d-flex flex-column justify-content-center py-4"
                        style="border-color: #60cdff;">
                        <div class="stat-num">{{ stats.edificios }}</div>
                        <div class="text-white-50 text-uppercase small ls-1">Edificios Activos</div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card-glass stat-card h-50 d-flex flex-column justify-content-center py-4"
                        style="border-color: #bc13fe;">
                        <div class="stat-num">{{ stats.users }}</div>
                        <div class="text-white-50 text-uppercase small ls-1">Usuarios Totales</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h6 class="text-white-50 text-uppercase fw-bold mb-3 ps-2 border-start border-4 border-info">Usuarios por Edificio
    </h6>

    <div class="row g-4 mb-4">
        {% for e in edificios %}
        <div class="col-lg-6">
            <div class="user-count-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="d-flex align-items-center mb-2">
                            <span class="led-indicator {{ 'led-active' if e.activo else 'led-inactive' }}"></span>
                            <h4 class="fw-bold text-white m-0">{{ e.nombre }}</h4>
                        </div>
                        <p class="text-white-50 small text-truncate mb-3"><i class="bi bi-geo-alt me-1"></i>{{ e.direccion }}</p>
                        
                        <div class="d-flex gap-2">
                            <a href="/superadmin/detalle_edificio/{{ e.id }}" class="btn btn-sm btn-info text-dark fw-bold px-3">
                                <i class="bi bi-gear-fill me-1"></i> GESTIONAR
                            </a>
                            <div class="form-check form-switch d-flex align-items-center bg-black bg-opacity-25 px-3 py-1 rounded border border-white border-opacity-10">
                                <input class="form-check-input ms-0 me-2" type="checkbox" role="switch"
                                    onchange="toggleEdificio('{{ e.id }}', this)" {{ 'checked' if e.activo else '' }}>
                                <label class="small text-white-50 fw-bold" style="font-size: 0.65rem;">{{ 'ACTIVO' if e.activo else 'OFF' }}</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-5 border-start border-white border-opacity-10 ps-md-4 mt-3 mt-md-0">
                        <div class="bg-black bg-opacity-25 rounded p-3 border border-white border-opacity-10 mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-white-50 fw-bold" style="font-size: 0.65rem;">DEUDA AEXON</span>
                                <span class="fw-bold {{ 'text-danger' if e.deuda_omnisoft > 0 else 'text-success' }}">
                                    ${{ "{:,.0f}".format(e.deuda_omnisoft) | replace(',', '.') }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white-50 fw-bold" style="font-size: 0.65rem;">ESTADO</span>
                                <span class="badge {{ 'bg-success' if e.estado_pago == 'PAGADO' else 'bg-warning text-dark' }}" style="font-size: 0.55rem;">{{ e.estado_pago }}</span>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start">
                                <div class="user-badge {{ 'text-muted' if not e.activo else '' }} lh-1">{{ e.cantidad_usuarios }}</div>
                                <div class="text-white-50" style="font-size: 0.6rem;">USUARIOS</div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger border-0 opacity-50"
                                onclick="confirmarEliminarEdificio('{{ e.id }}', '{{ e.nombre }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-muted">No hay edificios registrados.</div>
        {% endfor %}

        <div class="col-lg-6">
            <button class="user-count-card justify-content-center align-items-center h-100 w-100"
                style="border-style: dashed; background: transparent;" data-bs-toggle="modal"
                data-bs-target="#modalCrearEdificio">
                <div class="text-center">
                    <i class="bi bi-plus-circle fs-2 text-white-50 mb-2"></i>
                    <div class="text-white-50 fw-bold">Nuevo Edificio</div>
                </div>
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card-glass p-4 h-100">
                <h6 class="text-white fw-bold mb-3"><i class="bi bi-megaphone-fill me-2 text-warning"></i> Comunicado
                    Global</h6>
                <p class="small text-white-50 mb-3">Envía un mensaje a la bitácora de todos los edificios activos.</p>
                <form action="/superadmin/broadcast" method="POST">
                    <div class="mb-3">
                        <input type="text" name="titulo" class="form-control form-control-sm mb-2"
                            placeholder="Título del mensaje" required>
                        <textarea name="mensaje" class="form-control form-control-sm" rows="3"
                            placeholder="Escribe el comunicado aquí..." required></textarea>
                    </div>
                    <button class="btn btn-warning btn-sm w-100 fw-bold text-dark">
                        <i class="bi bi-send-fill me-1"></i> ENVIAR A TODOS
                    </button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card-glass">
                <div class="header-dark d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-info"><i class="bi bi-eye-fill me-2"></i> Ojo de Dios (Logs)</h6>
                    <span class="badge bg-dark border border-secondary">En Vivo</span>
                </div>
                <div class="log-feed">
                    {% for log in global_logs %}
                    <div class="log-row">
                        <div class="log-time">
                            <div class="fw-bold text-white">{{ log.tiempo }}</div>
                            <div style="font-size:0.65rem">{{ log.fecha_full.split(' ')[1] }}</div>
                        </div>
                        <div class="log-badge">
                            {% if log.tipo == 'VISITA' %}<span
                                class="badge bg-primary bg-opacity-25 text-primary w-100">VISITA</span>
                            {% elif log.tipo == 'PAGO' %}<span
                                class="badge bg-success bg-opacity-25 text-success w-100">PAGO</span>
                            {% else %}<span class="badge bg-secondary bg-opacity-25 text-white w-100">{{ log.tipo
                                }}</span>{% endif %}
                        </div>
                        <div class="log-content">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold text-white">{{ log.detalle }}</span>
                                <span class="log-actor text-info">{{ log.actor }}</span>
                            </div>
                            <span class="log-building"><i class="bi bi-building me-1"></i>{{ log.edificio }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card-glass p-0 overflow-hidden d-flex flex-column" style="height: 450px;">
                <div class="header-dark">
                    <h6 class="m-0 fw-bold"><i class="bi bi-map-fill me-2"></i> Mapa de Operaciones</h6>
                </div>
                <div id="map" class="flex-grow-1" style="width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearEdificio" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 bg-dark">
                <h5 class="fw-bold text-white">Nuevo Condominio</h5><button class="btn-close btn-close-white"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-dark">
                <form action="/superadmin/crear_edificio" method="POST">
                    <label class="small text-muted mb-1">Nombre</label>
                    <input type="text" name="nombre" class="form-control mb-3" required>
                    <label class="small text-muted mb-1">Dirección (Google)</label>
                    <input type="text" name="direccion" id="googleAddressInput" class="form-control mb-3" required
                        placeholder="Escribe para buscar...">
                    <input type="hidden" name="lat" id="latInput">
                    <input type="hidden" name="lon" id="lonInput">
                    <button class="btn btn-primary w-100 fw-bold">Crear y Activar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalGhostLogin" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-glass" style="border-color: #ffc107;">
            <div class="modal-header border-0 bg-warning bg-opacity-10">
                <h5 class="fw-bold text-warning"><i class="bi bi-incognito me-2"></i>Modo Fantasma</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-white-50 small mb-3">Busca un administrador o conserje para tomar control de su sesión.
                </p>
                <div class="input-group mb-3">
                    <span class="input-group-text bg-dark border-secondary text-white"><i
                            class="bi bi-search"></i></span>
                    <input type="text" id="ghostSearchInput" class="form-control bg-dark text-white border-secondary"
                        placeholder="Nombre o RUT..." onkeyup="buscarUsuarioGhost()">
                </div>
                <div id="ghostResults" style="max-height: 200px; overflow-y: auto;">
                    <div class="text-center text-white-50 py-3 small">Escribe para buscar...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="formEliminarEdificio" action="/superadmin/eliminar_edificio" method="POST">
    <input type="hidden" name="edificio_id" id="deleteId">
</form>

<script>
    function updateServerTime() { document.getElementById('server-time').textContent = new Date().toLocaleTimeString('es-CL'); }
    setInterval(updateServerTime, 1000); updateServerTime();

    function initGoogleAutocomplete() {
        const input = document.getElementById('googleAddressInput');
        if (!input || typeof google === 'undefined') return;
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.addListener('place_changed', function () {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                document.getElementById('latInput').value = place.geometry.location.lat();
                document.getElementById('lonInput').value = place.geometry.location.lng();
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        // 1. Inicializar Autocomplete
        initGoogleAutocomplete();

        // 2. Inicializar Sparkline (Solo si existe Chart.js)
        if (typeof Chart !== 'undefined') {
            const ctxSpark = document.getElementById('renderSparkline').getContext('2d');
            const renderChart = new Chart(ctxSpark, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        data: Array(20).fill(0).map(() => Math.random() * 100),
                        borderColor: '#0d6efd',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false, min: 0, max: 120 } },
                    animation: { duration: 0 }
                }
            });

            setInterval(() => {
                renderChart.data.datasets[0].data.shift();
                const lastVal = renderChart.data.datasets[0].data[renderChart.data.datasets[0].data.length - 1];
                const newVal = Math.max(10, Math.min(100, lastVal + (Math.random() * 40 - 20)));
                renderChart.data.datasets[0].data.push(newVal);
                renderChart.update();
            }, 2000);
        }

        // 3. Inicializar Mapa
        var map = L.map('map').setView([-33.437, -70.650], 12);
        
        setTimeout(() => { map.invalidateSize(); }, 200);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        
        var data = {{ edificios | tojson | safe }};
    var bounds = [];

    const urlParams = new URLSearchParams(window.location.search);
    const highlightId = urlParams.get('highlight');
    let highlightMarker = null;

    // Definir el icono personalizado de edificio
    const buildingIcon = L.divIcon({
        className: 'custom-building-icon',
        html: `<div class="building-marker-inner"><i class="bi bi-buildings-fill"></i></div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -36]
    });

    data.forEach(e => {
        // CORRECCIÓN: Buscamos latitud O lat, longitud O lon
        let lat = e.latitud || e.lat;
        let lon = e.longitud || e.lon;

        if (lat && lon) {
            let marker = L.marker([lat, lon], { icon: buildingIcon }).addTo(map)
                .bindPopup(`<b>${e.nombre}</b><br>${e.cantidad_usuarios} Usuarios<br><a href="/superadmin/detalle_edificio/${e.id}" class="btn btn-sm btn-primary mt-1 text-white">Ver Panel</a>`);
            bounds.push([lat, lon]);

            if (highlightId && e.id == highlightId) {
                highlightMarker = { lat, lon, marker };
                    // Esperar a que el marcador esté en el DOM para aplicar la clase
                    setTimeout(() => {
                        const el = marker.getElement();
                        if (el) el.classList.add('highlight-pulse');
                    }, 300);
            }
        }
    });

    if (highlightMarker) {
        map.setView([highlightMarker.lat, highlightMarker.lon], 16);
        highlightMarker.marker.openPopup();
    } else if (bounds.length) {
        map.fitBounds(bounds, { padding: [50, 50] });
    }
    });

    function confirmarEliminarEdificio(id, nombre) {
        Swal.fire({
            title: '¿ELIMINAR EDIFICIO?', text: `Se desactivará "${nombre}". Ingrese la CONTRASEÑA MAESTRA:`,
            input: 'password', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', background: '#1a1d24', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed && result.value === "T3t1n53m$") {
                document.getElementById('deleteId').value = id;
                document.getElementById('formEliminarEdificio').submit();
            } else if (result.isConfirmed) {
                Swal.fire({ title: 'ACCESO DENEGADO', icon: 'error', background: '#1a1d24', color: '#fff' });
            }
        });
    }

    function toggleEdificio(id, checkbox) {
        const estado = checkbox.checked;
        fetch(`/superadmin/toggle_edificio/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activo: estado })
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'success',
                        title: 'Estado actualizado', showConfirmButton: false, timer: 2000,
                        background: '#1a1d24', color: '#fff'
                    }).then(() => location.reload());
                } else {
                    checkbox.checked = !estado;
                    Swal.fire('Error', 'No se pudo cambiar el estado', 'error');
                }
            });
    }

    // --- LÓGICA MODO DIOS (GHOST) ---
    let debounceTimer;
    function buscarUsuarioGhost() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            let q = document.getElementById('ghostSearchInput').value;
            if (q.length < 2) return;

            let resDiv = document.getElementById('ghostResults');
            resDiv.innerHTML = '<div class="text-center text-info"><div class="spinner-border spinner-border-sm"></div> Buscando...</div>';

            fetch(`/superadmin/buscar_usuarios_global?q=${q}`)
                .then(r => r.json())
                .then(data => {
                    if (data.length === 0) {
                        resDiv.innerHTML = '<div class="text-center text-white-50 py-2">No se encontraron usuarios activos.</div>';
                        return;
                    }
                    let html = '';
                    data.forEach(u => {
                        html += `
                        <div class="ghost-result-item animate__animated animate__fadeIn">
        <div>
            <div class="fw-bold text-white">${u.nombre}</div>
            <div class="small text-white-50">${u.rol.toUpperCase()} • ${u.edificio}</div>
            <div class="small text-muted" style="font-size:0.65rem">${u.rut}</div>
        </div>
        <form action="/superadmin/ghost_login/${u.rut}" method="POST">
            <button class="btn btn-sm btn-warning fw-bold shadow-sm">
                <i class="bi bi-box-arrow-in-right"></i> ENTRAR
            </button>
        </form>
    </div>`;
                    });
                    resDiv.innerHTML = html;
                });
        }, 300);
    }
</script>
{% endblock %}