{% extends "base.html" %}
{% block title %}| Mi Hogar{% endblock %}

{% block styles %}
<meta name="theme-color" content="#0dcaf0">
<link rel="manifest" href="/manifest.json">
<style>
    /* DiseÃ±o App Mobile-First */
    body { padding-bottom: 90px; background: #0a0a0f; } 
    
    .app-header { 
        background: linear-gradient(180deg, rgba(20,20,30,0.95) 0%, rgba(10,10,15,0) 100%);
        padding: 20px 15px; position: sticky; top: 0; z-index: 1000; 
    }
    
    .building-info { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    
    .card-app { background: #1a1d24; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 15px; overflow: hidden; }
    
    .btn-invite {
        border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.03); color: white; transition: 0.2s; height: 100%; width: 100%;
    }
    .btn-invite:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
    .btn-invite i { font-size: 2rem; margin-bottom: 10px; }

    .btn-pay { background: linear-gradient(45deg, #0dcaf0, #0d6efd); border: none; border-radius: 12px; color: white; font-weight: bold; padding: 12px; width: 100%; }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #13131f; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; backdrop-filter: blur(10px); }
    .nav-item-app { color: rgba(255,255,255,0.5); text-align: center; text-decoration: none; font-size: 0.75rem; }
    .nav-item-app.active { color: #0dcaf0; }
    .nav-item-app i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="app-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white fw-bold shadow" style="width: 45px; height: 45px; font-size: 1.2rem;">{{ u.numero }}</div>
            <div>
                <h5 class="m-0 text-white fw-bold">{{ session.nombre.split()[0] }}</h5>
                <span class="text-info small fw-bold">Residente</span>
            </div>
        </div>
        <a href="/logout" class="text-white-50 p-2"><i class="bi bi-box-arrow-right fs-4"></i></a>
    </div>

    <div class="building-info">
        <div class="d-flex align-items-center gap-2 mb-1">
            <i class="bi bi-building text-warning"></i>
            <span class="fw-bold text-white">{{ edificio.nombre }}</span>
        </div>
        <div class="text-white-50 small ps-4">{{ edificio.direccion }}</div>
    </div>
</div>

<div class="container px-3">
    
    <h6 class="text-white-50 text-uppercase small fw-bold mb-3 ps-1">Accesos & Visitas</h6>
    <div class="row g-3 mb-4">
        <div class="col-6">
            <button class="btn-invite" onclick="abrirModalInvitacion('PEATON')">
                <i class="bi bi-person-walking text-success"></i>
                <span class="fw-bold">Visita a Pie</span>
                <span class="text-white-50 small" style="font-size: 0.7rem;">Sin estacionamiento</span>
            </button>
        </div>
        <div class="col-6">
            <button class="btn-invite" onclick="abrirModalInvitacion('VEHICULO')">
                <i class="bi bi-car-front-fill text-warning"></i>
                <span class="fw-bold">Visita Auto</span>
                <span class="text-white-50 small" style="font-size: 0.7rem;">Con estacionamiento</span>
            </button>
        </div>
    </div>

    <div class="card-app p-4 text-center">
        <h6 class="text-white-50 text-uppercase ls-1 small">Estado de Cuenta</h6>
        <h1 class="display-5 fw-bold {% if u.deuda_monto > 0 %}text-danger{% else %}text-success{% endif %} my-2">
            ${{ "{:,.0f}".format(u.deuda_monto) }}
        </h1>
        <p class="text-white-50 small mb-3">{% if u.deuda_monto > 0 %}Tienes pagos pendientes{% else %}Â¡EstÃ¡s al dÃ­a! ðŸŒŸ{% endif %}</p>
        {% if u.deuda_monto > 0 %}
        <form action="/residente/pagar_deuda" method="POST">
            <input type="hidden" name="unidad_id" value="{{ u.id }}">
            <input type="hidden" name="monto" value="{{ u.deuda_monto }}">
            <button class="btn-pay shadow"><i class="bi bi-credit-card-2-front me-2"></i> PAGAR TOTAL</button>
        </form>
        {% endif %}
    </div>

    <div class="card-app p-3 mt-3">
        <h6 class="text-white fw-bold mb-3 d-flex align-items-center"><i class="bi bi-stars text-warning me-2"></i> Reservar Amenities</h6>
        <form action="/residente/reservar" method="POST">
            <div class="input-group mb-2">
                <select name="espacio_id" class="form-select bg-dark text-white border-secondary" required onchange="actualizarPrecio(this)">
                    <option value="" data-precio="0">Â¿QuÃ© deseas reservar?</option>
                    {% for e in espacios %}
                    <option value="{{ e.id }}" data-precio="{{ e.precio }}">{{ e.nombre }} ({{ e.capacidad }}p)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group mb-3">
                <input type="date" name="fecha" class="form-control bg-dark text-white border-secondary" required min="{{ hoy }}">
                <span class="input-group-text bg-dark border-secondary text-info fw-bold" id="precioLabel">$0</span>
            </div>
            <button class="btn btn-outline-info w-100 fw-bold">Confirmar Reserva</button>
        </form>
        
        {% if mis_reservas %}
        <div class="mt-3 pt-3 border-top border-secondary">
            <small class="text-white-50 mb-2 d-block">Tus prÃ³ximas reservas:</small>
            {% for r in mis_reservas %}
            <div class="d-flex justify-content-between align-items-center bg-black bg-opacity-25 p-2 rounded mb-1">
                <span class="text-white small">{{ r.nombre_espacio }}</span>
                <span class="badge bg-primary">{{ r.fecha_uso }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {% if encomiendas %}
    <div class="card-app p-3 border-warning border-opacity-50 bg-warning bg-opacity-10">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-warning text-dark rounded-circle p-2"><i class="bi bi-box-seam-fill fs-4"></i></div>
            <div>
                <h6 class="text-white fw-bold m-0">Â¡LlegÃ³ Paquete!</h6>
                <p class="text-white-50 small m-0">{{ encomiendas|length }} por retirar en conserjerÃ­a.</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="text-center mt-4 mb-3">
        <button class="btn btn-link text-white-50 text-decoration-none btn-sm" data-bs-toggle="modal" data-bs-target="#modalPerfil">
            <i class="bi bi-gear-fill me-1"></i> Configurar mi Perfil
        </button>
    </div>
</div>

<div class="bottom-nav">
    <a href="#" class="nav-item-app active"><i class="bi bi-house-door-fill"></i>Inicio</a>
    <a href="#" class="nav-item-app"><i class="bi bi-receipt"></i>Historial</a>
    <a href="#" class="nav-item-app"><i class="bi bi-chat-dots-fill"></i>Ayuda</a>
</div>

<div class="modal fade" id="modalGenerarInv" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="modal-title text-white">Nueva InvitaciÃ³n <span id="tipoInvTitulo" class="text-info"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p class="text-white-50 small mb-3">Puedes pre-llenar el nombre de tu visita para agilizar su ingreso.</p>
                <input type="hidden" id="tipoInvInput">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="nombreVisitaInput" placeholder="Nombre (Opcional)">
                    <label class="text-white-50">Nombre Visita (Opcional)</label>
                </div>
                <button class="btn btn-success w-100 fw-bold py-3" onclick="generarLink()">
                    <i class="bi bi-link-45deg me-2"></i> CREAR PASE DE ACCESO
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPerfil" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Mis Datos</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/residente/perfil/editar" method="POST"><div class="mb-3"><label>Email</label><input type="email" name="email" value="{{ user.email }}" class="form-control"></div><div class="mb-3"><label>TelÃ©fono</label><input type="text" name="telefono" value="{{ user.telefono }}" class="form-control"></div><button class="btn btn-primary w-100">Guardar</button></form></div></div></div></div>

<script>
    function actualizarPrecio(select) {
        let precio = select.options[select.selectedIndex].getAttribute('data-precio');
        document.getElementById('precioLabel').textContent = "$" + parseInt(precio).toLocaleString();
    }

    function abrirModalInvitacion(tipo) {
        document.getElementById('tipoInvInput').value = tipo;
        document.getElementById('tipoInvTitulo').textContent = tipo === 'PEATON' ? 'Peatonal' : 'Vehicular';
        new bootstrap.Modal(document.getElementById('modalGenerarInv')).show();
    }

    function generarLink() {
        let tipo = document.getElementById('tipoInvInput').value;
        let nombre = document.getElementById('nombreVisitaInput').value;
        let btn = document.querySelector('#modalGenerarInv .btn-success');
        
        btn.disabled = true; btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Generando...';

        fetch('/residente/invitar/generar', {
            method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `tipo=${tipo}&nombre=${nombre}`
        })
        .then(r => r.json())
        .then(d => {
            bootstrap.Modal.getInstance(document.getElementById('modalGenerarInv')).hide();
            Swal.fire({
                title: 'Â¡Pase Listo!',
                html: `<p class="text-white-50">Comparte este link. Tu visita deberÃ¡ completar sus datos.</p>
                       <div class="input-group mb-3">
                           <input type="text" class="form-control bg-dark text-white border-secondary" value="${d.link}" id="linkInv" readonly>
                           <button class="btn btn-success" onclick="copiarLink()"><i class="bi bi-whatsapp"></i></button>
                       </div>`,
                background: '#1a1d24', color: '#fff', showConfirmButton: false
            });
            btn.disabled = false; btn.innerHTML = '<i class="bi bi-link-45deg me-2"></i> CREAR PASE DE ACCESO';
        });
    }
    
    function copiarLink() {
        let copyText = document.getElementById("linkInv");
        copyText.select();
        document.execCommand("copy");
        window.open(`https://wa.me/?text=Hola, aquÃ­ tienes tu invitaciÃ³n para ingresar al edificio: ${copyText.value}`, '_blank');
    }
</script>
{% endblock %}